Feature Name: Generate Certificates
Status: Draft
Start Date: 19-04-2021
Authors: @prafull01, @abhishek, @madhur

# Summary

This RFC proposes a method of deploying the cockroach db helm chart in a secure mode without need of manual steps for the user.
This manual steps for any user could be error prone and might discourage users to run cockroach db in secure mode for test environments.
Also, this RFC eliminates the need of kubernetes CA to sign our certificates. We will sign our own certificates and manage those certificates.

# Motivation

Existing mechanism to install the cockroach db helm chart requires the Kubernete CA to sign the node and client 
certificates through CSR, and user has to provide those certificates in form of secret and then deploy our helm chart.
The current way we are using CSR is no longer support with Certificates.k8s.io/v1 API and will be deprecated in 
kubernetes v1.22.

Many kubernetes distribution like VMware Tanzu, EKS etc are not allowing kubernetes CA to sign the CSR's using kubernetes 
CA. This adversely affects the cockroach db secure mode installation on any such distribution.

Implementation of the approach in the RFC is expected to make cockroach db secure mode installation independent of 
underlying platform

It will also provide better user experience where the secure mode should just work when user runs `helm install` command.

## Goals

1. Helm install command should be self-sufficient to launch the cockroach db cluster in secure mode.
   
2. Moving away from using kubernetes CA to approve our certificates, use either self generated CA or user provided CA.
    
## Non-Goals

1. We don't intend to change the init containers already present in the helm chart, but due to scope of this PR those needs to be changed.

2. Encourage user to use cockroach db in secure mode which is a default mode provided.

## Helm Configuration

1. Option specifying cockroach db to manage the certificates, `tls.certs.generate.enabled` as true/false.
   Enabling this option means cockroach db will create node and client certificates using the Certificate Authority. 

2. Option specifying cockroach db to use user provided CA which will be used to sign the node and client certificates, 
   `tls.certs.generate.caProvided: true/false`
    This enables user to either provide the custom CA or use the CA generated by cockroach db. 
   
3. Option specifying the secret name containing user provide CA `tls.certs.generate.caSecret`, we will use user provided CA to sign the node and client certificates.
   This enables user to provide its own CA in a secret , and we will use the user provided CA to sign the node and client certificates.
   This option is mandatory if the `tls.certs.generate.caProvided` is true.
   
4. Option specifying the CA certificate expiration duration from user `tls.certs.generate.caCertDuration`.
   This duration will only be used when we create our own CA. By default, the CA expiry would be set to 10 years.
   
5. Option specifying the client certificate expiration duration from user `tls.certs.generate.clientCertDuration`.
   This will create client certificates of specified duration only. By default, client certificate expiry would be set to 1 year.

6. Option specifying the node certificate expiration duration from user `tls.certs.generate.nodeCertDuration`.
   This will create node certificates of specified duration only. By default, node certificate expiry would be set to 1 year.
   
7. Certificate rotation enable or not using `tls.certs.generate.rotateCerts: true/false`
   This will rotate the certificates, before the expiry.

## Helm Input Validation

1. If `tls.certs.generate.caProvided` is true, the `tls.certs.generate.caSecret` should be provided as well.
   
2. If `tls.certs.generate.caSecret` is provided, secret should exist in the cockroach db install namespace.
   
3. `tls.certs.generate.caCertDuration` should be greater than the `tls.certs.generate.clientCertDuration` and `tls.certs.generate.nodeCertDuration`

## Implementation Details 

## Helm Flow:

- A `pre-install` hook job will be added that runs before all the helm chart resources are installed. This job will only
  run when `tls.certs.generate.enabled` is set to `true`. Along with the `pre-install` hook job, serviceAccount, role and 
  rolebinding will also be created as part of `pre-install` hooks with different `hook-weight` so that the `pre-install`
  job have sufficient permissions to perform certificate generation.

  | Resource       	| Hook-weight 	| Order of Installation 	|
  |----------------	|-------------	|-----------------------	|
  | ServiceAccount 	| 1           	| 1st                   	|
  | Role           	| 2           	| 2nd                   	|
  | RoleBindings   	| 3           	| 3rd                   	|
  | Job            	| 4           	| 4th                   	|

  After all the `pre-install` hooks completed successfully, they will be deleted by hook deletion-policy defined in
  annotations.
    

  1. This `pre-install` job will have two work-flows depending upon the value of `tls.certs.generate.caProvided` 
      - When CA is self-signed i.e. `tls.certs.generate.caProvided: false`:
        
        CA will be generated by cockroach db and is saved in the CA secret. Name of the secret will be `cockroachdb-ca`.
        Then this CA will be is used to generate nodeSecret and clientRootSecret certs and then saved in `cockroachdb-node` and 
        `cockroachdb-root` secret respectively.
      - When CA is given by the user i.e. `tls.certs.generate.caProvided: true`:
        
        User given CA secret will be used to get the CA information and sign the nodeSecret and clientRootSecret certificates
        and save them in `cockroachdb-node` and`cockroachdb-root` secret.
        
  2. For all the generated certificates, their duration will be driven by the duration value set in the values.yaml.
        - Generated CA certificate life duration, default 10 years: `tls.certs.generate.caCertDuration`
        - Generated Node certificate life duration, default 1 year: ``tls.certs.generate.nodeCertDuration``
        - Generate Client certificate life duration, default 1 year: `tls.certs.generate.clientCertDuration`
  
  3. All the certificate generation related info will be passed on to the `pre-install` job as env variables.
     ```yaml
     env:
        - name: CA_CERT_DURATION
          value: {{ default 3650 .Values.tls.certs.generate.caCertDuration}}
        - name: NODE_CERT_DURATION
          value: {{ default 365 .Values.tls.certs.generate.nodeCertDuration}}
        - name: Client_CERT_DURATION
          value: {{ default 365 .Values.tls.certs.generate.clientCertDuration}}
        {{- if and (tls.certs.generate.caProvided .Values.tls.certs.generate.caSecret) }}
            {{- if not (lookup "v1" "Secret" ".Release.Namespace" ".Values.tls.certs.generate.caSecret")}}
            {{ fail "CA secret doesn't exist in cluster"}}
            {{- end }}
        - name: CA_SECRET
          values: 
        {{- end }}
     ```

- 3 empty secret will be added in helm chart for `cockroachdb-ca`, `cockroachdb-node` and `cockroachdb-root` if `tls.certs.generate.enabled`
  is set. These secrets will be populated in the `pre-install` job. In case CA is provided by the user, then `cockroachdb-ca` secret is skipped.
  Empty secrets are added to allow proper cleanup during helm uninstall.

- A cron-job is also added in helm chart when `tls.certs.generate.rotateCerts` is set. This cron-job will run periodically to rotate the certificates.
  The schedule of the cron-job will be the minimum of `nodeCertDuration` and `clientCertDuration`. On every schedule run, it will
  check if there is any certificate which is going to expire before the next scheduled run, if yes then it will renew the certificates.
  
  If the CA is created by cockroach db:
  - check the CA certificate expiry and if the expiry is less than the next cronjob schedule,then do the certificate rotation.
    If CA is rotated, then the node certificates and client certificates need to be rotated.

    `TODO: Discuss about the 2 crons, one for CA rotation few months prior to Node cert rotation`
  If the CA is provided by user:
  - CA is not considered at all. Check the for expiry of node certificates and client certificates. If certificate expiry
    is less than the next scheduled run, then do cert rotation.
    
- The cron-job will use the same `pre-install` job image for certificate rotations. The `pre-install` job image binary will
  have an argument `--rotate` for handling certificate rotation.

`TODO:Need to identify how to generate the SIGHUP signal in all the nodes for certificate renewal`

- The Stateful pod will now only run `copy-certs` initContainer to copy the certificates from nodeSecret to emptyDir volume.
  Rest of the main db container flow will remain the same.
  
- Right now client certificate is generated in the `post-install` job. In case of `tls.certs.generate` set to true, it will be
  generated in `pre-install` job only. So this `post-install` job also will run `copy-certs` initContainer to copy the certificates
  from clientRootSecret to emptyDir volume. Rest of the main cluster-init container flow will remain the same

### Certificate Generation cases during helm upgrade:

In case of helm upgrade:
- if certificate management method is changed from cert generation to `cert-manager` or `default manual k8s CSR approval`,
  do nothing as this `pre-install` job  won't be triggered.
  
- if same cert management method is used, then `pre-install` job will check:
    ```text
    - When `caCertDuration`, `nodeCertDuration` or `clientCertDuration` is changed:
        `TODO: What to do when any of the cert duration is decreased compared to last value`
        - if `caCertDuration` is increased: generate new CA. Sign nodeCert and clientCert with the new CA and trigger refresh command.
        - if `nodeCertDuration` is increased: generate  new nodeCert and trigger refresh command
        - if `clientCertDuration`is increased: generate new clientCert.
    `TODO: Do we need to check below conditions if same cert generation method is used and duration is also?
     I think CA secret, nodeSecret and clientSecret are already populated with certificate info, and no need to update
    cert. Discuss` 
        if CA secret has data:
            if not generate CA
            if yes then do nothing
        if node cert is empty:
            if yes generate node cert using CA
            if no, validate node cert using CA
                if valid, do nothing
                if not valid, generate new node certificates and follow node cert rotation process
    ```
  
- if certificate management method is changed from cert generation to `custom user CA`, generate new nodeCert and clientCert
  singed by custom user CA and trigger refresh CA.
