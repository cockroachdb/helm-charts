Feature Name: Generate Certificates
Status: Draft
Start Date: 19-04-2021
Authors: @prafull01, @abhishek, @madhur

# Summary

This RFC proposes a method of deploying the cockroach db helm chart in a secure mode without need of kubernetes CA to 
sign our certificates. We will sign our own certificates and manage those certificates, this means we no longer require 
user to do manual steps before deploying cockroach db helm chart in secure mode.

# Motivation

Existing mechanism to install the cockroach db helm chart requires the Kubernete CA to sign the node and client 
certificates through CSR, and user has to provide those certificates in form of secret and then deploy our helm chart.
The current way we are using CSR is no longer support with Certificates.k8s.io/v1 API and will be deprecated in 
kubernetes v1.22.

Many kubernetes distribution like VMware Tanzu, EKS etc are not allowing kubernetes CA to sign the CSR's using kubernetes 
CA. This adversely affects the cockroach db secure mode installation on any such distribution.

Implementation of the approach in the RFC is expected to make cockroach db secure mode installation independent of 
underlying platform

It will also provide better user experience where the secure mode should just work when user runs `helm install` command.

## Goals

1. Helm install command should be self-sufficient to launch the cockroach db cluster in secure mode.
   
2. Moving away from using kubernetes CA to approve our certificates, use either self generated CA or user provided CA.
    
## Non-Goals

## Helm Configuration

1. Option specifying cockroach db to manage the certificates, `tls.certs.generate.enabled` as true/false.
   Enabling this option means cockroach db will create node and client certificates using the Certificate Authority. 

2. Option specifying cockroach db to use user provided CA which will be used to sign the node and client certificates, 
   `tls.certs.generate.caProvided: true/false`
    This enables user to either provide the custom CA or use the CA generated by cockroach db. 
   
3. Option specifying the secret name containing user provide CA `tls.certs.generate.caSecret`, we will use user provided CA to sign the node and client certificates.
   This enables user to provide its own CA in a secret , and we will use the user provided CA to sign the node and client certificates.
   This option is mandatory if the `tls.certs.generate.caProvided` is true.
   
4. Option specifying the CA certificate expiration duration from user `tls.certs.generate.caCertDuration`.
   This duration will only be used when we create our own CA. By default, the CA expiry would be set to 10 years.
   
5. Option specifying the client certificate expiration duration from user `tls.certs.generate.clientCertDuration`.
   This will create client certificates of specified duration only. By default, client certificate expiry would be set to 1 year.

6. Option specifying the node certificate expiration duration from user `tls.certs.generate.nodeCertDuration`.
   This will create node certificates of specified duration only. By default, node certificate expiry would be set to 1 year.
   
7. Certificate rotation enable or not using `tls.certs.generate.rotateCerts: true/false`
   This will rotate the certificates, before the expiry.

## Helm Input Validation

1. If `tls.certs.generate.caProvided` is true, the `tls.certs.generate.caSecret` should be provided as well.
   
2. If `tls.certs.generate.caSecret` is provided, secret should exist in the cockroach db install namespace.
   
3. `tls.certs.generate.caCertDuration` should be greater than the `tls.certs.generate.clientCertDuration` and `tls.certs.generate.nodeCertDuration`

## Implementation Details
    
    