# CockroachDB Helm Chart

[CockroachDB](https://github.com/cockroachdb/cockroach) - the open source, cloud-native distributed SQL database.

This is a subchart for installing the CockroachDB cluster.

### Running in secure mode

In order to set up a secure cockroachdb cluster set `cockroachdb.tls.enabled` to `true`

There are 3 ways to configure a secure cluster, with this chart. This all relates to how the certificates are issued:

* Self-signer (default)
* Manual
* Cert-manager


#### Self-signer

This is the default behaviour, and requires no configuration beyond setting certificate durations if user wants to set custom duration.

If you are running in this mode, self-signed certificates are created by self-signed utility for the nodes and root client and are stored in a secret.
You can look for the certificates created:

```shell
$ kubectl get secrets

crdb-cockroachdb-ca-secret                 Opaque                                2      23s
crdb-cockroachdb-client-secret             kubernetes.io/tls                     3      22s
crdb-cockroachdb-node-secret               kubernetes.io/tls                     3      23s
```
By default, the certs are created by the self-signer utility. In case of a custom CA cert, modify the configuration under the `tls` section:

```
  cockroachdb:
    tls:
      selfSigner:
        caProvided: true
        caSecret: <ca-secret-name>
```

#### Manual

If you wish to supply the certificates to the nodes yourself set `cockroachdb.tls.externalCertificates.enabled` to `true`. You may want to use this if you want to use a different certificate authority from the one being used by Kubernetes or if your Kubernetes cluster doesn't fully support certificate-signing requests. To use this, first set up your certificates and load them into your Kubernetes cluster as Secrets using the commands below:

```shell
$ mkdir certs
$ mkdir my-safe-directory
$ cockroach cert create-ca --certs-dir=certs --ca-key=my-safe-directory/ca.key
$ cockroach cert create-client root --certs-dir=certs --ca-key=my-safe-directory/ca.key
$ kubectl create secret generic cockroachdb-root --from-file=certs
secret/cockroachdb-root created
$ cockroach cert create-node --certs-dir=certs --ca-key=my-safe-directory/ca.key localhost 127.0.0.1 my-release-cockroachdb-public my-release-cockroachdb-public.my-namespace my-release-cockroachdb-public.my-namespace.svc.cluster.local *.my-release-cockroachdb *.my-release-cockroachdb.my-namespace *.my-release-cockroachdb.my-namespace.svc.cluster.local
$ kubectl create secret generic cockroachdb-node --from-file=certs
secret/cockroachdb-node created
```

> Note: The subject alternative names are based on a release called `my-release` in the `my-namespace` namespace. Make sure they match the services created with the release during `helm install`

If your certificates are stored in tls secrets such as secrets generated by cert-manager, the secret will contain files named:

* `ca.crt`
* `tls.crt`
* `tls.key`

Cockroachdb, however, expects the files to be named like this:

* `ca.crt`
* `node.crt`
* `node.key`
* `client.root.crt`
* `client.root.key`


#### Cert-manager

If you wish to provision certificates using [cert-manager][1], follow the steps below:

  * By default, cert-manager stores the CA certificate in a Secret, which is used by the Issuer.

  * To provide the CA certificate in a ConfigMap (required by some applications like CockroachDB), you can use the [trust-manager][3] project.

  * The trust-manager can be configured to copy the CA cert from a Secret to a ConfigMap automatically.

  * If your CA Secret is in the cockroachdb namespace, your trust-manager deployment must also reference that namespace. You can set the trust namespace using the Helm value: --set app.trust.namespace=cockroachdb.

Example Setup:

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: cockroachdb-ca
  namespace: cockroachdb
data:
  tls.crt: [BASE64 Encoded ca.crt]
  tls.key: [BASE64 Encoded ca.key]
type: kubernetes.io/tls
---
apiVersion: cert-manager.io/v1alpha3
kind: Issuer
metadata:
  name: cockroachdb
  namespace: cockroachdb
spec:
  ca:
    secretName: cockroachdb-ca
---
apiVersion: trust.cert-manager.io/v1alpha1
kind: Bundle
metadata:
  name: cockroachdb-ca
spec:
  sources:
    - secret:
        name: cockroachdb-ca
        key: ca.crt
  target:
    configMap:
      key: ca.crt
    namespaceSelector:
      matchLabels:
       kubernetes.io/metadata.name: cockroachdb
```
> üîç Bundle will create a ConfigMap named cockroach-ca in the cockroachdb namespace with a ca.crt key copied from the Secret's tls.crt.

üîß **values.yaml configuration** :

To enable cert-manager integration via Helm, configure the following:

```yaml
cockroachdb:
  tls:
    enabled: true
    selfSigner:
      enabled: false
    certManager:
      enabled: true
      # caSecret defines the secret name that contains the CA certificate.
      caConfigMap: cockroachdb-ca
      # nodeSecret defines the secret name that contains the node certificate.
      nodeSecret: cockroachdb-node
      # clientRootSecret defines the secret name that contains the root client certificate.
      clientRootSecret: cockroachdb-root
      # issuer specifies the Issuer or ClusterIssuer resource to use for issuing node and client certificates.
      # The values correspond to the issuerRef in the certificate.
      issuer:
        # group specifies the API group of the Issuer resource.
        group: cert-manager.io
        # kind specifies the kind of the Issuer resource.
        kind: Issuer
        # name specifies the name of the Issuer resource.
        name: cockroachdb
        # clientCertDuration specifies the duration of client certificates.
        clientCertDuration: 672h
        # clientCertExpiryWindow specifies the rotation window before client certificate expiry.
        clientCertExpiryWindow: 48h
        # nodeCertDuration specifies the duration for node certificates.
        nodeCertDuration: 8760h
        # nodeCertExpiryWindow specifies the rotation window before node certificate expiry.
        nodeCertExpiryWindow: 168h
```

# CockroachDB Helm Chart

[CockroachDB](https://github.com/cockroachdb/cockroach) - the cloud-native distributed SQL database.

Below is a brief overview of operating the CockroachDB Helm Chart(v2) with Operator.

## Prerequisites

* Kubernetes 1.30 or higher
* Helm 3.0 or higher
* Create a namespace to perform the operations against. In this case, we are using `cockroach-ns` namespace.
* If you want to secure your cluster to use TLS certificates for all network communications, [Helm must be installed with RBAC privileges](https://helm.sh/docs/topics/rbac/) or else you will get an "attempt to grant extra privileges" error.

Set the environment variables:

``` shell
export CRDBOPERATOR=crdb-operator
export CRDBCLUSTER=cockroachdb
export NAMESPACE=cockroach-ns
```

## Notes

All the helm commands below reference the chart folder available locally after checking out this GitHub repository. Alternatively, you may also reference the charts in the Helm repository.
The operator chart does not exist in the Helm repository yet and will be added soon.

## Installation

### Install Operator

- Update `cloudRegion` accordingly in [`operator/values.yaml`](/cockroachdb-parent/charts/operator/values.yaml). This value must be same as the current region provided under regions section at [`cockroachdb/values.yaml`](/cockroachdb-parent/charts/cockroachdb/values.yaml).

```
  cloudRegion: us-central1
```

```shell
$ helm install $CRDBOPERATOR ./cockroachdb-parent/charts/operator -n $NAMESPACE
```

### Install CockroachDB

- Modify the `regions` configuration of [`cockroachdb/values.yaml`](/cockroachdb-parent/charts/cockroachdb/values.yaml). The default `regions` configuration uses k3d, so update it as per your cloud provider (e.g. `gcp`, `aws`, etc.)

```
  cockroachdb:
    crdbCluster:
      regions:
        - code: us-central1
          nodes: 3
          cloudProvider: gcp
          namespace: cockroach-ns
```
- If the `cloudProvider` is `azure`, create an application in your Azure tenant and create a secret named `azure-cluster-identity-credentials-secret` which contains `azure_client_id` and  `azure_client_secret` to hold the application credentials.[2]
- Modify the other relevant configuration like `topologySpreadConstraints`, `localityLabels`,  `service.ports`, as required.

Install the cockroachdb chart:

```shell
$ helm install $CRDBCLUSTER ./cockroachdb-parent/charts/cockroachdb -n $NAMESPACE
```
You can Override the default parameters using the `--set key=value[,key=value]` argument while installing the chart.

```shell
helm install $CRDBCLUSTER  ./cockroachdb-parent/charts/cockroachdb --set clusterDomain=cluster-test.local -n $NAMESPACE
```

Alternatively, a YAML file that specifies custom values for the parameters can be provided while installing the chart. For example:

```shell
$ helm install $CRDBCLUSTER ./cockroachdb-parent/charts/cockroachdb -f my-values.yaml -n $NAMESPACE
```

### Multi Region Deployments

For multi-region cluster deployments, ensure the required networking is setup which allows for service discovery across regions. Also, ensure that the same CA cert is used across all the regions.

For each region, modify the `regions` configuration of [`cockroachdb/values.yaml`](/cockroachdb-parent/charts/cockroachdb/values.yaml) and perform `helm install` as above against the respective Kubernetes cluster.

While applying `helm install` in a given region:
- Verify that the domain matches the `clusterDomain` in [`cockroachdb/values.yaml`](/cockroachdb-parent/charts/cockroachdb/values.yaml) for the corresponding region.
- Ensure `regions` captures the information for regions that have already been deployed, including the current region. This enables CockroachDB in the current region to connect to CockroachDB deployed in the existing regions.

For example, if `us-central1` has already been deployed, and `us-east1` is being deployed to:

```
  cockroachdb:
    clusterDomain: cluster.gke.gcp-us-east1
    crdbCluster:
      regions:
        - code: us-central1
          nodes: 3
          cloudProvider: gcp
          domain: cluster.gke.gcp-us-central1
          namespace: cockroach-ns
        - code: us-east1
          nodes: 3
          cloudProvider: gcp
          domain: cluster.gke.gcp-us-east1
          namespace: cockroach-ns
```

## Upgrade CockroachDB cluster

Modify the required configuration in [`cockroachdb/values.yaml`](/cockroachdb-parent/charts/cockroachdb/values.yaml) and perform an upgrade through Helm:

```shell
$ helm upgrade --reuse-values $CRDBCLUSTER ./cockroachdb-parent/charts/cockroachdb --values ./cockroachdb-parent/charts/cockroachdb/values.yaml -n $NAMESPACE
```

## Scale Up/Down CockroachDB cluster

Update the nodes accordingly under `regions` section and perform the helm upgrade:

```
  regions:
    - code: us-central1
      nodes: 4
      cloudProvider: gcp
      domain: cluster.gke.gcp-us-central1
      namespace: cockroach-ns
```

```shell
$ helm upgrade --reuse-values $CRDBCLUSTER ./cockroachdb-parent/charts/cockroachdb --values ./cockroachdb-parent/charts/cockroachdb/values.yaml -n $NAMESPACE
```

## Rolling Restart of CockroachDB Cluster

Update the timestamp annotation to do a rolling restart of all CockroachDB pods:

```shell
$ helm upgrade --reuse-values $CRDBCLUSTER ./cockroachdb-parent/charts/cockroachdb --set-string cockroachdb.crdbCluster.timestamp="$(date -u +"%Y-%m-%dT%H:%M:%SZ")" -n $NAMESPACE
```

## Kill a CockroachDB Node

```shell
$ kubectl delete pod <pod-name> -n $NAMESPACE
```

## Uninstalling the Chart

To uninstall/delete the CockroachDB cluster:

```bash
helm uninstall $CRDBCLUSTER -n $NAMESPACE
```


## Connecting to the CockroachDB cluster

Follow the steps documented in https://www.cockroachlabs.com/docs/stable/deploy-cockroachdb-with-kubernetes?filters=helm#step-3-use-the-built-in-sql-client to create a secure CockroachDB client.
You could confirm the regions using a SQL command as below:

```
> SHOW regions;
      region      |                          zones                          | database_names | primary_region_of | secondary_region_of
------------------+---------------------------------------------------------+----------------+-------------------+----------------------
  gcp-us-central1 | {gcp-us-central1-b,gcp-us-central1-c,gcp-us-central1-f} | {}             | {}                | {}
  gcp-us-east1    | {gcp-us-east1-b,gcp-us-east1-c,gcp-us-east1-d}          | {}             | {}                | {}
(2 rows)
```

In order to access the DB console, follow the steps documented in https://www.cockroachlabs.com/docs/stable/deploy-cockroachdb-with-kubernetes?filters=helm#step-4-access-the-db-console.
Use the corresponding Service name that is suffixed by `-public` (in this case, `$CRDBCLUSTER-public`).

[1]: https://cert-manager.io/
[2]: https://learn.microsoft.com/en-us/dotnet/api/azure.identity.environmentcredential?view=azure-dotnet
[3]: https://cert-manager.io/docs/trust/trust-manager/
